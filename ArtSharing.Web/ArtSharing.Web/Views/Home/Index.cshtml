@model List<ArtSharing.Data.Models.Models.Post>
@using ArtSharing.Data.Models.Models

@{
    ViewData["Title"] = "Home";
}

<h1 class="text-center my-4">🖼️ Art Feed</h1>

<div class="container">
    <!-- Filter Controls -->
    <div class="row mb-4">
        <div class="col-md-6">
            <input type="text" id="searchInput" class="form-control" placeholder="Search by title or description..." />
        </div>
        <div class="col-md-4">
            <select id="categoryFilter" class="form-select">
                <option value="">All Categories</option>
                @if (ViewBag.Categories is List<Category> categories)
                {
                    foreach (var category in categories)
                    {
                        <option value="@category.Id">@category.Name</option>
                    }
                }
            </select>
        </div>
    </div>

    <!-- Posts Section -->
    <div id="postContainer" class="row row-cols-1 row-cols-md-3 g-4">
        @foreach (var post in Model)
        {
            <div class="col">
                @await Html.PartialAsync("_PostCardPartial", post)
            </div>
        }
    </div>

    <div class="text-center mt-4">
        <button id="loadMoreBtn" class="btn btn-outline-primary">Load more</button>
    </div>
</div>

@section Scripts {
    <script>
        let skipCount = @Model.Count;
        const takeCount = 6;

        const postContainer = document.getElementById("postContainer");
        const loadMoreBtn = document.getElementById("loadMoreBtn");
        const searchInput = document.getElementById("searchInput");
        const categoryFilter = document.getElementById("categoryFilter");

        loadMoreBtn.addEventListener("click", async function () {
            const response = await fetch(`/Home/LoadMorePosts?skip=${skipCount}&take=${takeCount}`);
            const html = await response.text();

            if (html.trim()) {
                postContainer.insertAdjacentHTML("beforeend", html);
                skipCount += takeCount;
            } else {
                loadMoreBtn.style.display = "none";
            }
        });

        async function filterPosts() {
            const search = searchInput.value.trim();
            const categoryId = categoryFilter.value;

            const url = `/Home/FilterPosts?searchTerm=${encodeURIComponent(search)}&categoryId=${categoryId}`;
            const response = await fetch(url);
            const html = await response.text();

            postContainer.innerHTML = html;
            loadMoreBtn.style.display = "none";
        }

        searchInput.addEventListener("input", debounce(filterPosts, 300));
        categoryFilter.addEventListener("change", filterPosts);

        function debounce(func, delay) {
            let timeout;
            return function () {
                clearTimeout(timeout);
                timeout = setTimeout(func, delay);
            };
        }
    </script>
}
